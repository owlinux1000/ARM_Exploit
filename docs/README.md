# Learning ARM Exploit Development

## はじめに

このリポジトリは、ARM Exploit について学習することができるリポジトリです。各章のドキュメントを読んで、各チャレンジを解きながら、ARM Exploit 開発について学ぶことができます。ARM の解析環境をお持ちでない方は、本ページの末尾にある[環境構築](#環境構築)を参考に環境を構築してみてください。また、本コンテンツの対象読者層は、x86, amd64 のExploit 開発をしたことがある人です。そのため、説明が少し省略されている部分もあるとは思いますがご了承ください。

## コンテンツ内容

|#|タイトル|
|:---|:---|
|1|シェルコード作成|
|2|スタックベースのバッファオーバーフロー|
|3|Return to libc を用いた攻撃|
|4|Return Oriented Programming（ROP）を用いた攻撃|

## 環境構築

ARM の解析環境を持っていない人向けに環境構築の方法をご紹介します。持っている方はご自身の環境をご利用ください。ARM 環境の実現方法には、Qemu のシステムエミュレーションを利用します。また、ディストリビューションとしてはRaspberry Pi で有名なRaspbian (Debian Buster) をエミュレートする環境を構築します。現段階ではホストOS には、macOS を想定していますが、おそらくQemu が動けば他のOS でも問題ないかと思います。 

まずはじめに、Qemu をインストールしましょう。

```bash
$ brew install qemu # macOS
$ sudo apt install qemu # Ubuntu など
```

次に、エミュレートする際に必要な、カーネル、ディスクイメージ、DTB ファイルをダウンロードします。それぞれ以下のリンクからダウンロードしてください。
- ディスクイメージ
  - http://ftp.jaist.ac.jp/pub/raspberrypi/raspbian_lite/images/
  - 2019-07-10-raspbian-buster-lite..zip (執筆当時)  
- カーネルとDTBファイル
  - https://github.com/dhruvvyas90/qemu-rpi-kernel
  - kernel-qemu-4.19.50-buster (執筆当時)
  - versatile-pb.dtb
  
上記ファイルのダウンロードと解凍が終わったら、以下の内容のシェルスクリプト`run.sh` を作成してください。localhost の10022/tcp をRaspbian の22/tcp につなぐ設定になっているので、都合が悪ければ適宜変更してください。また、8888/tcp はexploit　コードを送信するために使います。

```bash
#!/bin/sh
qemu-system-arm \
 -kernel kernel-qemu-4.19.50-buster \
 -cpu arm1176 \
 -M versatilepb \
 -dtb versatile-pb.dtb \
 -m 256 \
 -no-reboot \
 -append "root=/dev/sda2 panic=1 rootfstype=ext4 rw" \
 -hda 2019-07-10-raspbian-buster-lite.img \
 -nographic \
 -net nic -net user,hostfwd=tcp::10022-:22,hostfwd=tcp::8888-:8888
```

作成した`run.sh` を実行するとカーネルの起動画面がターミナルに表示されます。しばらく待つと、以下のログインプロンプトが表示されるので、`pi:raspberry` でログインできます。

```
Raspbian GNU/Linux 10 raspberrypi ttyAMA0

raspberrypi login:
```

デフォルトではsshのサービスが起動していないので必要であれば起動してください。`run.sh` で指定したポート番号を用いて、`ssh -p 10022 pi@127.0.0.1` でssh ログインすることができるようになります。

次に、本リポジトリで使うためのいくつかのソフトウェアをインストールしていきます。以下のコマンドを実行してください。

```bash
$ sudo apt install git socat ltrace
$ wget -q -O- https://github.com/hugsy/gef/raw/master/scripts/gef.sh | sh
```

また、gefを使う際にPythonのエラーが発生する可能性があるため、`.bashrc` に以下の`export LC_ALL=C.UTF-8` を追加して再度`.bashrc` を読み込んでください。

以上で、環境構築は終了です。

## 参考資料

- [Azeria Labs](https://azeria-labs.com/writing-arm-assembly-part-1/)
- [ARM Exploit Development](https://azeria-labs.com/downloads/Slides-SAS_final.pdf)
