# シェルコード作成

## はじめに

第1章では、Exploitには欠かせないシェルコード作成について学びます。シェルコードとは、攻撃の断片コードのようなもので、アセンブルしたバイナリ値などをExploit コードでは利用します。まずは、ARM の基本的な構文や仕組みについて **Exploit開発が行える程度** のご説明をします。次に実際のシェルコードを作成し、その動きを解説します。最後に、演習問題を通してどのようにシェルコードを扱うのかを理解します。

## ARM アセンブリ基礎

ARM の主要なレジスタには、r0 ~ r15レジスタとcpsrレジスタなどがあります。特にr11 ~ r15ジレスタは特殊な用途に使われるため以下のような別名が付けられています。

- r11 レジスタ：フレームポインタ(fp)
- r12 レジスタ：インストラクションポインタ(ip)
- r13 レジスタ：スタックポインタ(sp)
- r14 レジスタ：リンクレジスタ(lr)

また、cpsrレジスタはx86のeflagsレジスタのようなものでフラグ管理をしています。特に下位5bit目のフラグは重要な値になっており、ARMのARMステートとThumbステートと切り替える役割を持っています。ARMステートとThumbステートについては、後述します。  

ARM では、r0 ~ r3レジスタに引数を設定し、r0レジスタに戻り値がセットされます。5個以上の引数はスタック渡しされます。また、システムコールを直接呼ぶ場合は、Linuxにおいてはr7レジスタにシステムコール番号、r0 ~ r6レジスタに引数、r0レジスタに戻り値がセットされます。

では、まずはじめに`Hello` を出力するプログラム`hello.asm` を作成してみましょう。様々な命令を紹介するために少し冗長に構築しています。

```wasm
.text
.global _start
_start:
        eor r0, r0     @ r0 = 0
        add r0, #1     @ r0 += 1
        adr r1, s      @ r1 = &s
        mov r2, #6     @ r2 = 6
        mov r7, #4     @ r7 = 4
        svc 0          @ write(1, &s, 6)
        eor r0, r0     @ r0 = 0
        add r7, r0, #1 @ r7 = 1
        svc 0          @ exit(0)
s:
  .asciz "Hello\n"
```

各行の命令について補足していきます。eor 命令は、xorを行う命令です。引数に同じr0 レジスタを取っているため0初期化していることがわかります。add 命令は、加算を行う命令です。2番目のオペランドは、即値を表しています。したがって本命令は、r0にr0+1を代入する命令になっています。adr 命令は、ラベルのアドレスを第1オペランドに代入する用途で使っています。mov 命令は、値を代入する命令です。svc 命令は、システムコールを発行する命令です。オペランドは基本的に無視されます。ここでは、r7 レジスタに4が入っているためwrite システムコールを発行し、`Hello\n` を出力します。その後の3命令はもう読み解けるでしょう。システムコール番号を調べる際には、`ausyscall` コマンドが便利です。以下のようにシステムコール名を与えることで、システムコール番号を表示してくれます。

```bash
pi@raspberrypi:~/ARM_Exploit/challenge01 $ ausyscall write
write              4
writev             146
pwrite64           181
pciconfig_write    273
pwritev            362
process_vm_writev  377
pwritev2           393
```

また、本コードから実行ファイルを作成する際には、以下のように`as` と`ld` コマンドを用います。実行すると前述した通り文字列を表示して終了します。

```bash
$ as hello.asm -o hello.o
$ ld hello.o -o hello
$ ./hello
Hello
```
## Thumb ステートメント

ARM には、通常のARM ステートとThumb ステートの2つのステートが存在します。以下に主な違いを示します。

|観点|ARM ステート|Thumb ステート|
|:----:|:---:|:---:|
|命令語の長さ|4 byte| 2 byte|
|扱える汎用レジスタの数| 16個|8個|

ARM ステートとThumb ステートの切り替えには、BX 命令とBLX 命令が利用されます。BX r0 のようにレジスタ指定で制御が移る場合は、レジスタの中身が偶数であればARM ステート、奇数であればThumb ステートに切り替わります。よくある例として、`add r3, pc, #1; bx r3` を実行すると、r3 レジスタには、pc+1の奇数のアドレスが格納され、そのアドレスに対してジャンプするため、元がARM ステートの場合はThumb ステートに切り替わります。Exploit 開発においては、Thumb ステートメントは命令語の長さが短いため長さを短くしたい場合にとても便利です。

## 演習問題

`execve("/bin/sh", NULL, NULL)` を実行するプログラムを作成してみましょう。
