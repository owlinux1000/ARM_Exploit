<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4. Playing with Canary</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/ARM_Exploit/assets/css/0.styles.e466e900.css" as="style"><link rel="preload" href="/ARM_Exploit/assets/js/app.a8b518b7.js" as="script"><link rel="preload" href="/ARM_Exploit/assets/js/2.2d619ac4.js" as="script"><link rel="preload" href="/ARM_Exploit/assets/js/3.96930671.js" as="script"><link rel="prefetch" href="/ARM_Exploit/assets/js/10.27ea7a0c.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/4.edb5607f.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/5.b26f25b5.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/6.f5bf7ae1.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/7.95503b68.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/8.0b79b2fc.js"><link rel="prefetch" href="/ARM_Exploit/assets/js/9.4e0fd8de.js">
    <link rel="stylesheet" href="/ARM_Exploit/assets/css/0.styles.e466e900.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ARM_Exploit/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ARM_Exploit/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://twitter.com/encry1024" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About me
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/owlinux1000/ARM_Exploit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Repository
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ARM_Exploit/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://twitter.com/encry1024" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About me
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/owlinux1000/ARM_Exploit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Repository
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/ARM_Exploit/" class="sidebar-link">Home</a></li><li><a href="/ARM_Exploit/chapter01/" class="sidebar-link">1. Crafting Shellcode</a></li><li><a href="/ARM_Exploit/chapter02/" class="sidebar-link">2. Buffer Overflow</a></li><li><a href="/ARM_Exploit/chapter03/" class="sidebar-link">3. Return to libc</a></li><li><a href="/ARM_Exploit/chapter04/" class="active sidebar-link">4. Playing with Canary</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter04/#_4-1-arm-におけるcanary" class="sidebar-link">4.1 ARM におけるCanary</a></li><li class="sidebar-sub-header"><a href="/ARM_Exploit/chapter04/#_4-2-まとめ" class="sidebar-link">4.2 まとめ</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4-playing-with-canary"><a href="#_4-playing-with-canary" aria-hidden="true" class="header-anchor">#</a> 4. Playing with Canary</h1> <p>この章では、2章で少し頭出しをしたCanary についてもう少し深く見ていきます。Canary は、SSP によるBuffer Overflow を検知するための値です。x86においてCanaryは、<code>fs:[0x28]</code> に格納されており、読み出すには若干手間がかかります。しかしながら、ARM においては別の場所に格納されています。本章ではARM におけるCanaryの特徴を簡単にご紹介します。</p> <h2 id="_4-1-arm-におけるcanary"><a href="#_4-1-arm-におけるcanary" aria-hidden="true" class="header-anchor">#</a> 4.1 ARM におけるCanary</h2> <p>まずは、<code>bof2</code> をgefで読み込んで、<code>start</code> コマンドを入力してください。<code>bof2</code> は、SSPを有効にした状態でコンパイルしています。
SSP では、関数の先頭で、Canaryをスタックに配置する処理を行います。ここではその様子を見ていきます。</p> <p><img src="/ARM_Exploit/assets/img/image1.e5f26420.png" alt="bof2の開始直後の様子"></p> <p>ここで、<code>ldr</code> 命令により、0x105a8の値をr3レジスタにロードしようとしています。さらに、r3レジスタをアドレスとして指す値を、r3レジスタに格納しようとしています。その後、<code>str</code> 命令によって、r3レジスタの値を、<code>[r11, #-8]</code> つまりフレームポインタ-8のアドレスに格納しようしています。この時、r3レジスタにはどんな値が入っているか確認するために、<code>si</code>命令で2命令勧めて、<code>i r r3</code> でr3レジスタの値を確認してみましょう。</p> <p><img src="/ARM_Exploit/assets/img/image2.5b5faa4b.png" alt="Canaryの値"></p> <p>r3 レジスタには、0x1d7afc00という値が入っていることが確認できました。Canary の末尾1byteがNULL バイトであるという特徴にマッチしています。実は、この値がCanaryになっています。ここまで見てきたようにCanaryの値の元は、0x105a8に入っていました。このアドレスは、どこのセクションに位置するのか確認してみましょう。こういった際には、<code>xinfo</code> コマンドが便利です。</p> <p><img src="/ARM_Exploit/assets/img/image3.9679aee3.png" alt="xinfoの結果"></p> <p>xinfoの結果よりから、0x105a8は.textセクションに位置していることがわかりました。これは、つまりASLR の影響を受けないことを意味しています。また、ROPなどでリークが簡単にできるアドレスに格納されているため、他の脆弱性と合わせることで、Canary をリークすることが可能となります。</p> <p>最後にCanary の比較処理を見てみましょう。main+88の周辺を見てみましょう。</p> <p><img src="/ARM_Exploit/assets/img/image4.78868e20.png" alt="Canaryの検査部分"></p> <p>最初の命令では、0x105a8から値をr3レジスタにロードしています。次に、Canaryを保存していた<code>[r11, #-8]</code>からr2レジスタに値をロードしています。その後、r3レジスタをアドレスとして指す値をr3レジスタにロードしています。これにより、元のCanaryの値をr3レジスタに格納できます。その後、<code>cmp</code> 命令で、スタック上のCanaryであるr2と、元のCanaryであるr3レジスタを比較して、等しければ<code>&lt;main+112&gt;</code>にジャンプ（<code>beq</code>は等しければジャンプする）し、終了処理に向かいます。しかし等しくなければ、<code>stack_chk_fail</code> という強制終了処理が走る関数を実行します。</p> <h2 id="_4-2-まとめ"><a href="#_4-2-まとめ" aria-hidden="true" class="header-anchor">#</a> 4.2 まとめ</h2> <p>本章では、ARM におけるCanaryについて見てきました。ARM のCanaryの値は、<code>.text</code> セクションに格納されているため、他の脆弱性と組み合わせることで、Canaryをリークして、SSP をバイパスすることが可能となります。これは、x86系と異なる仕組みなのでARM Exploit開発をする上で重要な知見だといえます。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ARM_Exploit/chapter03/" class="prev">3. Return to libc</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ARM_Exploit/assets/js/app.a8b518b7.js" defer></script><script src="/ARM_Exploit/assets/js/2.2d619ac4.js" defer></script><script src="/ARM_Exploit/assets/js/3.96930671.js" defer></script>
  </body>
</html>
