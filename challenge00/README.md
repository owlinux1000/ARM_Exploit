# 環境構築

本リポジトリの教材では、armhf 環境におけるARM Exploit 技術を学ぶことができます。本章では、ARM バイナリを実行、デバッグするための環境を構築します。ホストOS には、Ubuntu Server 19.04 を利用します。ARM バイナリの実行やデバッグには、Qemuのユーザモードエミュレーションを利用します。以下のパッケージをインストールしてください。`g++-arm-linux-gnueabihf` はarmhf 環境のgccなどが含まれています。`gdb-multiarch` は、様々なアーキテクチャに対応したgdbが含まれています。`qemu-user-static` は、Qemuのユーザモードエミュレーションを利用するためのツールが含まれています。また、生のgdbでデバッグするのは若干不便な面も多いので、ここでは[pwndbg](https://github.com/pwndbg/pwndbg) を利用します。解析する際には、とても便利なので、こちらも公式サイトよりインストールしておいてください。

```
$ sudo apt install g++-arm-linux-gnueabihf gdb-multiarch qemu-user-static
```

インストールが完了したら、以下の`main.c` という以下のサンプルプログラムをお好きなエディタで作成してください。

```c
#include <stdio.h>
void main() {
    printf("Hello world!\n");
}
```

コンパイルする際には`arm-linux-gnueabihf-gcc` コマンドを用いて以下のように実行します。

```shell
$ arm-linux-gnueabihf-gcc main.c
```

また、実行する際には、`qemu-arm-static` コマンドを用いて以下のように実行します。

```shell
$ qemu-arm-static -L /usr/arm-linux-gnueabi a.out
Hello world!
```

ここまでで、一般的なコンパイルと実行の流れを見てきました。次にExploit 構築の際には必須となるデバッグ方法についてご紹介します。`qemu-arm-static` コマンドには、リモートデバッギング用のポートを待ち受ける `-g` オプションがあります。こちらを使って、デバッグしていきます。tmux やscreenなどシェルを2つ開ける環境を用意して、片方では以下のコマンドを実行してください。

```
$ qemu-arm-static -L /usr/arm-linux-gnueabi -g 1234 a.out
```

また、もう一方のシェルでは以下のコマンドを実行してください。

```
$ gdb-multiarch -x -ex "target remote :1234"
```

もしpwndbg をインストール済みであれば以下のような表示になり、ARM の逆アセンブル結果などが閲覧できると思います。
